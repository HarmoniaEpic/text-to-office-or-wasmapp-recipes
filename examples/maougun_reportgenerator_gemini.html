<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ページタイトル -->
    <title>魔王軍 営業報告プレゼン</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #9333ea; /* purple-600 */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* エラーオーバーレイ（変更禁止） */
        .error-overlay { position: fixed; inset: 0; background: rgba(17,24,39,0.25); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 9999; }
        .error-card { width: 100%; max-width: 880px; background: rgba(255,255,255,0.96); border: 1px solid rgba(55,65,81,0.25); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); padding: 20px; }
        .error-title { display:flex; align-items:center; gap:8px; font-weight:800; font-size:18px; color:#991b1b; }
        .error-subtitle { margin-top:6px; color:#374151; line-height:1.55; }
        .error-actions { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
        .copy-btn { border:1px solid rgba(55,65,81,.3); padding:8px 12px; border-radius:10px; font-weight:600; background:#fff; cursor: pointer; }
        .copy-btn:hover { background: #f3f4f6; }
        .error-pre { margin-top:12px; background:#0b1020; color:#e5e7eb; border-radius:12px; padding:12px 14px; max-height:320px; overflow:auto; white-space:pre-wrap; word-break:break-word; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,'Courier New',monospace; font-size:13px; line-height:1.45; }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen text-white">

    <div class="bg-gray-800 border border-purple-500/30 rounded-2xl shadow-2xl shadow-purple-900/50 p-8 sm:p-12 text-center max-w-lg w-full">
        <!-- 見出し -->
        <h1 class="text-2xl sm:text-3xl font-bold text-purple-300 mb-4">
            魔王軍 四半期営業報告
        </h1>

        <p id="status-message" class="text-gray-400 mb-6 h-12 flex items-center justify-center">
            ファイルの準備をしています...
        </p>

        <div id="loading-spinner" class="spinner mx-auto mb-6"></div>

        <button id="download-button" class="w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg shadow-purple-500/50 hover:bg-purple-700 transition duration-300 transform hover:scale-105" disabled>
            プレゼンをダウンロード
        </button>
    </div>

    <!-- Pythonコード -->
    <script type="text/python" id="python-code">
from pptx import Presentation
from pptx.util import Inches, Pt
from pptx.dml.color import RGBColor
from pptx.enum.text import PP_ALIGN
from io import BytesIO
import base64
import js

# プレゼンテーションの作成 (ワイドスクリーン 16:9)
prs = Presentation()
prs.slide_width = Inches(16)
prs.slide_height = Inches(9)

# --- スライド 1: タイトル ---
slide1_layout = prs.slide_layouts[0] # タイトルスライド
slide1 = prs.slides.add_slide(slide1_layout)
title1 = slide1.shapes.title
subtitle1 = slide1.placeholders[1]

title1.text = "魔王軍 四半期営業報告"
subtitle1.text = "報告者: 四天王 営業本部長 ベルゼブブ"
title1.text_frame.paragraphs[0].font.name = 'Yu Gothic'
subtitle1.text_frame.paragraphs[0].font.name = 'Yu Gothic'

# --- スライド 2: 実績サマリー ---
slide2_layout = prs.slide_layouts[1] # タイトルとコンテンツ
slide2 = prs.slides.add_slide(slide2_layout)
title2 = slide2.shapes.title
content2 = slide2.placeholders[1].text_frame

title2.text = "世界征服進捗サマリー"
title2.text_frame.paragraphs[0].font.name = 'Yu Gothic'
content2.clear() # 既存のテキストをクリア

p2_1 = content2.paragraphs[0]
p2_1.text = "今期目標：人間界の25%支配\n結果：目標を120%達成し、30%の支配領域を確保"
p2_1.font.name = 'Yu Gothic'
p2_1.font.size = Pt(28)

p2_2 = content2.add_paragraph()
p2_2.text = "・東の大陸の完全制圧に成功"
p2_2.level = 1
p2_2.font.name = 'Yu Gothic'
p2_2.font.size = Pt(24)

p2_3 = content2.add_paragraph()
p2_3.text = "・中央大陸の主要5都市を陥落"
p2_3.level = 1
p2_3.font.name = 'Yu Gothic'
p2_3.font.size = Pt(24)

p2_4 = content2.add_paragraph()
p2_4.text = "・「絶望」の感情エネルギー生産量が過去最高を記録"
p2_4.level = 1
p2_4.font.name = 'Yu Gothic'
p2_4.font.size = Pt(24)

# --- スライド 3: KPI分析 ---
slide3_layout = prs.slide_layouts[1]
slide3 = prs.slides.add_slide(slide3_layout)
title3 = slide3.shapes.title
content3 = slide3.placeholders[1].text_frame

title3.text = "主要KPI分析：魂の収穫と勇者撃退率"
title3.text_frame.paragraphs[0].font.name = 'Yu Gothic'
content3.clear()

p3_1 = content3.paragraphs[0]
p3_1.text = "魂の収穫数"
p3_1.font.name = 'Yu Gothic'
p3_1.font.bold = True
p3_1.font.size = Pt(28)

p3_2 = content3.add_paragraph()
p3_2.text = "目標100万に対し、実績150万（前年同期比 +50%）"
p3_2.level = 1
p3_2.font.name = 'Yu Gothic'
p3_2.font.size = Pt(24)

p3_3 = content3.add_paragraph()
p3_3.text = "要因：新戦術「恐怖の口コミマーケティング」が奏功"
p3_3.level = 2
p3_3.font.name = 'Yu Gothic'
p3_3.font.size = Pt(22)

p3_4 = content3.add_paragraph()
p3_4.text = "\n勇者撃退率"
p3_4.font.name = 'Yu Gothic'
p3_4.font.bold = True
p3_4.font.size = Pt(28)

p3_5 = content3.add_paragraph()
p3_5.text = "95%を維持（うち80%は門前払い）"
p3_5.level = 1
p3_5.font.name = 'Yu Gothic'
p3_5.font.size = Pt(24)

p3_6 = content3.add_paragraph()
p3_6.text = "要因：ダンジョンのトラップ改善と中堅幹部の育成"
p3_6.level = 2
p3_6.font.name = 'Yu Gothic'
p3_6.font.size = Pt(22)

# --- スライド 4: 課題と次期戦略 ---
slide4_layout = prs.slide_layouts[1]
slide4 = prs.slides.add_slide(slide4_layout)
title4 = slide4.shapes.title
content4 = slide4.placeholders[1].text_frame

title4.text = "課題および次期戦略"
title4.text_frame.paragraphs[0].font.name = 'Yu Gothic'
content4.clear()

p4_1 = content4.paragraphs[0]
p4_1.text = "当面の課題"
p4_1.font.name = 'Yu Gothic'
p4_1.font.bold = True
p4_1.font.size = Pt(28)

p4_2 = content4.add_paragraph()
p4_2.text = "・光の聖剣を持つ勇者の出現（特定済み、対策チーム派遣）"
p4_2.level = 1
p4_2.font.name = 'Yu Gothic'
p4_2.font.size = Pt(24)

p4_3 = content4.add_paragraph()
p4_3.text = "・天使軍による散発的な妨害活動"
p4_3.level = 1
p4_3.font.name = 'Yu Gothic'
p4_3.font.size = Pt(24)

p4_4 = content4.add_paragraph()
p4_4.text = "\n次期戦略"
p4_4.font.name = 'Yu Gothic'
p4_4.font.bold = True
p4_4.font.size = Pt(28)

p4_5 = content4.add_paragraph()
p4_5.text = "・西の大陸への侵攻開始（竜人族との同盟交渉）"
p4_5.level = 1
p4_5.font.name = 'Yu Gothic'
p4_5.font.size = Pt(24)

p4_6 = content4.add_paragraph()
p4_6.text = "・新規アンデッド兵の大量生産と配備"
p4_6.level = 1
p4_6.font.name = 'Yu Gothic'
p4_6.font.size = Pt(24)

# --- スライド 5: 結論 ---
slide5_layout = prs.slide_layouts[1]
slide5 = prs.slides.add_slide(slide5_layout)
title5 = slide5.shapes.title
content5 = slide5.placeholders[1].text_frame

title5.text = "結論：世界征服は計画通り"
title5.text_frame.paragraphs[0].font.name = 'Yu Gothic'
content5.clear()

p5_1 = content5.paragraphs[0]
p5_1.text = "魔王様、ご安心ください。すべては計画通りに進んでおります。\n来期も圧倒的な成果を報告することをお約束いたします。"
p5_1.font.name = 'Yu Gothic'
p5_1.font.size = Pt(28)

p5_2 = content5.add_paragraph()
p5_2.text = "\n以上、ご清聴ありがとうございました。"
p5_2.font.name = 'Yu Gothic'
p5_2.font.size = Pt(24)
p5_2.alignment = PP_ALIGN.CENTER


# BytesIOに保存
pptx_io = BytesIO()
prs.save(pptx_io)
pptx_io.seek(0)

# Base64エンコード
pptx_bytes = pptx_io.read()
pptx_base64 = base64.b64encode(pptx_bytes).decode('utf-8')

# JavaScriptに渡す（必須）
js.pptx_base64_data = pptx_base64

print("PPTX file has been generated in memory.")
    </script>

    <!-- エラーオーバーレイ（変更禁止） -->
    <div id="error-overlay" class="error-overlay" role="dialog" aria-modal="true" aria-labelledby="error-title">
        <div class="error-card">
            <div class="error-title" id="error-title">エラーが発生しました：AIのチャットエリアに以下のエラーメッセージを貼り付けて修正を依頼して下さい</div>
            <div class="error-subtitle">エラーの全文をコピーして、そのままAIに投げてください。原因の特定とパッチを提案します。</div>
            <div class="error-actions">
                <button id="copy-error" class="copy-btn" aria-label="エラーメッセージをコピーする">エラー全文をコピー</button>
                <button id="close-error" class="copy-btn" aria-label="このエラー表示を閉じる">閉じる</button>
            </div>
            <pre id="error-text" class="error-pre" tabindex="0" aria-live="polite"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script type="module">
        const statusMessage = document.getElementById('status-message');
        const downloadButton = document.getElementById('download-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const overlay = document.getElementById('error-overlay');
        const errorText = document.getElementById('error-text');
        const copyBtn = document.getElementById('copy-error');
        const closeBtn = document.getElementById('close-error');

        // エラーUI用イベントリスナー
        copyBtn?.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(errorText.textContent || '');
                copyBtn.textContent = 'コピーしました';
                setTimeout(() => (copyBtn.textContent = 'エラー全文をコピー'), 1200);
            } catch (_) {
                const r = document.createRange(); 
                r.selectNodeContents(errorText);
                const sel = window.getSelection(); 
                sel.removeAllRanges(); 
                sel.addRange(r);
            }
        });

        closeBtn?.addEventListener('click', () => { 
            overlay.style.display = 'none'; 
        });

        async function main() {
            try {
                statusMessage.textContent = '実行環境を読み込んでいます...';
                const pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/",
                });

                // python-pptxのインストール（削除禁止）
                statusMessage.textContent = 'ライブラリをインストール中...';
                await pyodide.loadPackage("micropip");
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install('python-pptx')
                `);

                statusMessage.textContent = 'プレゼン資料を作成しています...';
                const pythonCode = document.getElementById('python-code').textContent;
                window.pptx_base64_data = null; 
                await pyodide.runPythonAsync(pythonCode);
                const base64Data = window.pptx_base64_data;

                if (!base64Data) {
                    throw new Error("Pythonコードがデータを生成しませんでした。");
                }

                statusMessage.textContent = '魔王様、準備完了です！';
                loadingSpinner.style.display = 'none';
                downloadButton.disabled = false;
                downloadButton.addEventListener('click', () => downloadFile(base64Data, 'maougun-quarterly-report.pptx'));

            } catch (error) {
                console.error("エラーが発生しました:", error);
                
                try {
                    const details = (error && (error.stack || error.message || String(error))) || '不明なエラー';
                    errorText.textContent = details.trim();
                } catch(_) {
                    errorText.textContent = '不明なエラー';
                }
                
                overlay.style.display = 'flex';
                statusMessage.textContent = '処理を中断しました。';
                loadingSpinner.style.display = 'none';
            }
        }

        function downloadFile(base64Data, fileName) {
            try {
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation' });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }, 100);

            } catch (error) {
                console.error("ダウンロードに失敗:", error);
                statusMessage.textContent = 'ダウンロードに失敗しました。';
            }
        }

        window.onload = main;
    </script>
</body>
</html>
